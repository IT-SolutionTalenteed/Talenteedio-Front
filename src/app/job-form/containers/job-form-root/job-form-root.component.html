<div class="job-form-root">
  <app-loader [isLoading]="jobLoading$ | async">
    <app-job-form
      [job]="job$ | async"
      [user]="user$ | async"
      (apply)="onApply()"
      (refer)="onRefer()"
      (login)="onLogin()"
      (match)="onMatch()"
    ></app-job-form>
  </app-loader>
</div>

<modal #applyJobModal class="popup-modal success custom">
  <ng-template #modalBody>
    <app-loader
      [isLoading]="applyForJobLoading$ | async"
      style="width: 65%"
      [width]="80"
      [height]="80"
    >
      >
      <div class="modal-title">
        <div class="icon">
          <h4>
            <fa-icon
              [icon]="clipBoardIcon"
              style="color: rgb(25 103 210 / 68%)"
            ></fa-icon>
          </h4>
        </div>
        <h4>Apply for {{ (job$ | async)?.title }}</h4>
      </div>
      <p class="modal-p">You can select a CV or a LM to apply for the job</p>
      <form *ngIf="form" [formGroup]="form" (submit)="onApplyForJob(form)">
        <!-- <form> -->
        <div class="form-content">
          <label for="cvId"><strong>CV *</strong></label>
          <div class="control">
            <ng-select
              formControlName="cvId"
              [items]="CVs || []"
              bindLabel="title"
              bindValue="id"
              placeholder="Choose a CV"
              required
            >
            </ng-select>
            <app-validation-error
              [control]="form.controls['cvId']"
            ></app-validation-error>
          </div>
          <label for="lmId"><strong>LM</strong></label>
          <div class="control">
            <ng-select
              formControlName="lmId"
              [items]="LMs || []"
              bindLabel="title"
              bindValue="id"
              placeholder="Choose a cover letter"
            >
            </ng-select>
          </div>
        </div>
        <div class="error-content" *ngIf="applyForJobError$ | async">
          <div class="text-wrapper">
            {{ applyForJobError$ | async }}
          </div>
        </div>
        <button class="primary" type="submit">Apply</button>
      </form>
    </app-loader>
  </ng-template>
  <!-- <ng-template #modalFooter>
  </ng-template> -->
</modal>

<modal #referJobModal class="popup-modal success custom">
  <ng-template #modalBody>
    <app-loader
      [isLoading]="referJobLoading$ | async"
      style="width: 65%"
      [width]="80"
      [height]="80"
    >
      <div class="modal-title">
        <div class="icon">
          <h4>
            <fa-icon
              [icon]="faUserPlus"
              style="color: rgb(25 103 210 / 68%)"
            ></fa-icon>
          </h4>
        </div>
        <h4>Refer a talent</h4>
      </div>
      <form
        *ngIf="referForm"
        [formGroup]="referForm"
        (submit)="onReferJob(referForm)"
      >
        <!-- <form> -->
        <div class="form-content">
          <label for="talentEmail"><strong>Talent email *</strong></label>
          <div class="control">
            <input
              id="talentEmail"
              appScrollOnFocus
              formControlName="talentEmail"
              type="email"
              placeholder="Enter talent email"
              #first
            />
            <app-validation-error
              [control]="referForm.controls['talentEmail']"
            ></app-validation-error>
          </div>
          <label for="talentFullName"><strong>Talent Fullname *</strong></label>
          <div class="control">
            <input
              id="talentFullName"
              appScrollOnFocus
              formControlName="talentFullName"
              type="text"
              placeholder="Enter talent fullname"
            />
            <app-validation-error
              [control]="referForm.controls['talentFullName']"
            ></app-validation-error>
          </div>
          <label for="talentNumber"><strong>Talent phone</strong></label>
          <div class="control">
            <angular-intl-phone
              formControlName="talentNumber"
              [config]="config"
            />
            <app-validation-error
              [control]="referForm.controls['talentNumber']"
            ></app-validation-error>
          </div>
        </div>
        <div class="error-content" *ngIf="referJobError$ | async">
          <div class="text-wrapper">
            {{ referJobError$ | async }}
          </div>
        </div>
        <button class="primary" type="submit">Refer</button>
      </form>
    </app-loader>
  </ng-template>
  <!-- <ng-template #modalFooter>
  </ng-template> -->
</modal>

<modal #matchJobModal id="matchJobModal" class="popup-modal success custom">
  <ng-template #modalBody>
    <div class="match-modal-wrapper">
      <!-- Fixed Header Section -->
      <div class="match-modal-header">
        <div class="modal-title">
          <h4>Match Profile</h4>
        </div>

        <!-- Progress indicator -->
        <div class="match-progress">
          <div class="progress-step" [class.active]="matchStep === 'cv-selection'" [class.completed]="matchStep !== 'cv-selection'">
            <span class="step-number">1</span>
            <span class="step-label">CV Selection</span>
          </div>
          <div class="progress-line" [class.completed]="matchStep !== 'cv-selection'"></div>
          <div class="progress-step" [class.active]="matchStep === 'cv-preview'" [class.completed]="['job-preview', 'results'].includes(matchStep)">
            <span class="step-number">2</span>
            <span class="step-label">CV Preview</span>
          </div>
          <div class="progress-line" [class.completed]="['job-preview', 'results'].includes(matchStep)"></div>
          <div class="progress-step" [class.active]="matchStep === 'job-preview'" [class.completed]="matchStep === 'results'">
            <span class="step-number">3</span>
            <span class="step-label">Job Preview</span>
          </div>
          <div class="progress-line" [class.completed]="matchStep === 'results'"></div>
          <div class="progress-step" [class.active]="matchStep === 'results'">
            <span class="step-number">4</span>
            <span class="step-label">Results</span>
          </div>
        </div>
      </div>

      <!-- Scrollable Content Section -->
      <div class="match-modal-content">
        <app-loader
          [isLoading]="matchLoading && matchStep === 'results'"
          [width]="80"
          [height]="80"
        >
        
        <!-- STEP 1: CV Selection -->
        <div *ngIf="matchStep === 'cv-selection'" class="match-step">
          <p class="modal-p">Select your CV to match with this job</p>
          <form *ngIf="matchForm" [formGroup]="matchForm" (submit)="onSelectCV(matchForm); $event.preventDefault()">
            <div class="form-content">
              <label for="matchCvId"><strong>Select your CV *</strong></label>
              <div class="control">
                <ng-select
                  formControlName="cvId"
                  [items]="CVs || []"
                  bindLabel="title"
                  bindValue="id"
                  placeholder="Choose a CV"
                  required
                >
                </ng-select>
                <app-validation-error
                  [control]="matchForm.controls['cvId']"
                ></app-validation-error>
              </div>
            </div>
            <div class="error-content" *ngIf="matchError">
              <div class="text-wrapper">
                {{ matchError }}
              </div>
            </div>
            <div class="button-group">
              <button class="primary" type="submit">Continue</button>
            </div>
          </form>
        </div>

        <!-- STEP 2: CV Preview -->
        <div *ngIf="matchStep === 'cv-preview'" class="match-step">
          <div style="margin-top: 20px;">
            <div><strong>CV s√©lectionn√© :</strong> {{ selectedCV?.title }}</div>
            <div *ngIf="selectedCV?.fileUrl; else noPreview" style="margin-top:16px;">
              <iframe 
                [src]="selectedCV.fileUrl | safe"
                width="100%"
                height="500px"
                style="border: 1px solid #bbb; border-radius:8px;"
              ></iframe>
            </div>
            <ng-template #noPreview>
              <p style="color:#888; margin-top:16px;">Pas de PDF disponible pour ce CV.</p>
            </ng-template>
          </div>
          <div class="button-group">
            <button class="secondary" type="button" (click)="onGoBack()">Back</button>
            <button class="primary" type="button" (click)="onContinueFromCVPreview()">Continue</button>
          </div>
        </div>

        <!-- STEP 3: Job Preview -->
        <div *ngIf="matchStep === 'job-preview'" class="match-step">
          <div style="margin-top: 20px;">
            <h4 style="margin-bottom: 16px;">{{ (job$ | async)?.title }}</h4>
            <ng-container *ngIf="(job$ | async)?.content; else noJobContent">
              <div class="job-preview" [innerHTML]="(job$ | async)?.content" style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 16px; background: #f9f9f9;"></div>
            </ng-container>
            <ng-template #noJobContent>
              <div style="max-height: 500px; overflow-y: auto; border: 1px solid #ddd; border-radius: 8px; padding: 16px; background: #f9f9f9; color: #888; text-align: center;">
                <p style="font-style: italic;">Cette offre d'emploi n'a pas de description d√©taill√©e.</p>
              </div>
            </ng-template>
          </div>
          <div class="error-content" *ngIf="matchError">
            <div class="text-wrapper">
              {{ matchError }}
            </div>
          </div>
          <div class="button-group">
            <button class="secondary" type="button" (click)="onGoBack()">Back</button>
            <button 
              class="primary" 
              type="button" 
              (click)="onValidateMatch()"
              [disabled]="!canValidateMatch() || matchLoading"
              [title]="!canValidateMatch() ? 'CV ou description d\'offre manquant' : ''"
            >
              Validate & Get Match
            </button>
          </div>
        </div>

        <!-- STEP 4: Results -->
        <div *ngIf="matchStep === 'results'" class="match-step match-results">
          <div style="text-align: center; margin: 30px 0;">
            <div style="font-size: 72px; font-weight: bold; color: rgb(25 103 210 / 68%);">
              <span id="pourcentage">{{ matchPercentage }}</span>%
            </div>
            <p style="margin-top: 20px; color: #666; font-size: 18px;">
              Taux de correspondance avec cette offre d'emploi
            </p>
          </div>

          <!-- Synth√®se -->
          <div *ngIf="matchSynthesis" class="result-section synthesis">
            <h5>üìã Synth√®se de l'ad√©quation</h5>
            <p>{{ matchSynthesis }}</p>
          </div>

          <!-- Tableau d'√©valuation -->
          <div *ngIf="matchEvaluationTable && matchEvaluationTable.length > 0" class="evaluation-table-container">
            <h5>üìä Tableau d'√©valuation d√©taill√©</h5>
            <div class="table-wrapper">
              <table>
                <thead>
                  <tr>
                    <th>Crit√®res</th>
                    <th class="score-col">Note/10</th>
                    <th>Raisons</th>
                    <th>Commentaires</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let item of matchEvaluationTable">
                    <td class="criterion">{{ item.criterion }}</td>
                    <td class="score">
                      <span class="score-value" 
                            [ngClass]="{
                              'excellent': item.score >= 8,
                              'good': item.score >= 6 && item.score < 8,
                              'poor': item.score < 6
                            }">
                        {{ item.score }}
                      </span>
                    </td>
                    <td class="reasons">{{ item.reasons }}</td>
                    <td class="comments">{{ item.comments }}</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="grading-legend">
              <strong>Grille de notation :</strong> 1-3 = tr√®s insuffisant | 4-5 = insuffisant | 6-7 = correct | 8-9 = bon | 10 = excellent
            </div>
          </div>

          <!-- Interpr√©tation -->
          <div *ngIf="matchInterpretation" class="result-section interpretation">
            <h5>üéØ Interpr√©tation du r√©sultat</h5>
            <p>{{ matchInterpretation }}</p>
          </div>

          <!-- Recommandations -->
          <div *ngIf="matchRecommendations" class="result-section recommendations">
            <h5>üí° Recommandations</h5>
            <p>{{ matchRecommendations }}</p>
          </div>

          <div class="error-content" *ngIf="matchError">
            <div class="text-wrapper">
              {{ matchError }}
            </div>
          </div>

          <div class="button-group" style="margin-top: 30px;">
            <button class="primary" type="button" (click)="closeMatchModal()">Fermer</button>
          </div>
        </div>
        
        </app-loader>
      </div>
    </div>
  </ng-template>